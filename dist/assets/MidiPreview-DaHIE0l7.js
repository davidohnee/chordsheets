import{P as S,d as A,c as x,a as L,F as T,r as P,N as I,g as D,v as w,o as k,_ as E}from"./main-c0_bQcCc.js";var B={exports:{}},U;function V(){return U||(U=1,(function(p){(function(){const v=function(n){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/;if(n=n.replace(/^.*?base64,/,""),n=String(n).replace(/[\t\n\f\r ]+/g,""),!e.test(n))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");n+="==".slice(2-(n.length&3));let o,l="",a,d,r=0;for(;r<n.length;)o=t.indexOf(n.charAt(r++))<<18|t.indexOf(n.charAt(r++))<<12|(a=t.indexOf(n.charAt(r++)))<<6|(d=t.indexOf(n.charAt(r++))),l+=a===64?String.fromCharCode(o>>16&255):d===64?String.fromCharCode(o>>16&255,o>>8&255):String.fromCharCode(o>>16&255,o>>8&255,o&255);return l},f={debug:!1,parse:function(n,t){if(n instanceof Uint8Array)return f.Uint8(n);if(typeof n=="string")return f.Base64(n);if(n instanceof HTMLElement&&n.type==="file")return f.addListener(n,t);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(n,t){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(n===void 0||!(n instanceof HTMLElement)||n.tagName!=="INPUT"||n.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;t=t||function(){},n.addEventListener("change",function(e){if(!e.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let o=new FileReader;o.readAsArrayBuffer(e.target.files[0]),o.onload=function(l){t(f.Uint8(new Uint8Array(l.target.result)))}})},Base64:function(n){n=String(n);let t=v(n),e=t.length,o=new Uint8Array(new ArrayBuffer(e));for(let l=0;l<e;l++)o[l]=t.charCodeAt(l);return f.Uint8(o)},Uint8:function(n){let t={data:null,pointer:0,movePointer:function(a){return this.pointer+=a,this.pointer},readInt:function(a){if(a=Math.min(a,this.data.byteLength-this.pointer),a<1)return-1;let d=0;if(a>1)for(let r=1;r<=a-1;r++)d+=this.data.getUint8(this.pointer)*Math.pow(256,a-r),this.pointer++;return d+=this.data.getUint8(this.pointer),this.pointer++,d},readStr:function(a){let d="";for(let r=1;r<=a;r++)d+=String.fromCharCode(this.readInt(1));return d},readIntVLV:function(){let a=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)a=this.readInt(1);else{let d=[];for(;this.data.getUint8(this.pointer)>=128;)d.push(this.readInt(1)-128);let r=this.readInt(1);for(let s=1;s<=d.length;s++)a+=d[d.length-s]*Math.pow(128,s);a+=r}return a}};if(t.data=new DataView(n.buffer,n.byteOffset,n.byteLength),t.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;t.readInt(4);let e={};e.formatType=t.readInt(2),e.tracks=t.readInt(2),e.track=[];let o=t.readInt(1),l=t.readInt(1);o>=128?(e.timeDivision=[],e.timeDivision[0]=o-128,e.timeDivision[1]=l):e.timeDivision=o*256+l;for(let a=1;a<=e.tracks;a++){e.track[a-1]={event:[]};let d=t.readInt(4);if(d===-1)break;if(d!==1297379947)return!1;t.readInt(4);let r=0,s=!1,i,u;for(;!s&&(r++,e.track[a-1].event[r-1]={},e.track[a-1].event[r-1].deltaTime=t.readIntVLV(),i=t.readInt(1),i!==-1);)if(i>=128?u=i:(i=u,t.movePointer(-1)),i===255){e.track[a-1].event[r-1].type=255,e.track[a-1].event[r-1].metaType=t.readInt(1);let c=t.readIntVLV();switch(e.track[a-1].event[r-1].metaType){case 47:case-1:s=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:e.track[a-1].event[r-1].data=t.readStr(c);break;case 33:case 89:case 81:e.track[a-1].event[r-1].data=t.readInt(c);break;case 84:e.track[a-1].event[r-1].data=[],e.track[a-1].event[r-1].data[0]=t.readInt(1),e.track[a-1].event[r-1].data[1]=t.readInt(1),e.track[a-1].event[r-1].data[2]=t.readInt(1),e.track[a-1].event[r-1].data[3]=t.readInt(1),e.track[a-1].event[r-1].data[4]=t.readInt(1);break;case 88:e.track[a-1].event[r-1].data=[],e.track[a-1].event[r-1].data[0]=t.readInt(1),e.track[a-1].event[r-1].data[1]=t.readInt(1),e.track[a-1].event[r-1].data[2]=t.readInt(1),e.track[a-1].event[r-1].data[3]=t.readInt(1);break;default:this.customInterpreter!==null&&(e.track[a-1].event[r-1].data=this.customInterpreter(e.track[a-1].event[r-1].metaType,t,c)),(this.customInterpreter===null||e.track[a-1].event[r-1].data===!1)&&(t.readInt(c),e.track[a-1].event[r-1].data=t.readInt(c),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch(i=i.toString(16).split(""),i[1]||i.unshift("0"),e.track[a-1].event[r-1].type=parseInt(i[0],16),e.track[a-1].event[r-1].channel=parseInt(i[1],16),e.track[a-1].event[r-1].type){case 15:{if(this.customInterpreter!==null&&(e.track[a-1].event[r-1].data=this.customInterpreter(e.track[a-1].event[r-1].type,t,!1)),this.customInterpreter===null||e.track[a-1].event[r-1].data===!1){let c=t.readIntVLV();e.track[a-1].event[r-1].data=t.readInt(c),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer")}break}case 10:case 11:case 14:case 8:case 9:e.track[a-1].event[r-1].data=[],e.track[a-1].event[r-1].data[0]=t.readInt(1),e.track[a-1].event[r-1].data[1]=t.readInt(1);break;case 12:case 13:e.track[a-1].event[r-1].data=t.readInt(1);break;case-1:s=!0;break;default:if(this.customInterpreter!==null&&(e.track[a-1].event[r-1].data=this.customInterpreter(e.track[a-1].event[r-1].metaType,t,!1)),this.customInterpreter===null||e.track[a-1].event[r-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return e},customInterpreter:null};p.exports=f})()})(B)),B.exports}var O=V();const R=S(O),K=p=>{if(!p)return null;const{track:v}=p,f=v.filter(l=>l.event.some(a=>a.type===9||a.type===8)),n=f[0].event.find(l=>l.metaType===3&&l.type===255)?.data,t=v.find(l=>l.event.some(a=>a.metaType===88&&a.type===255))?.event.map(l=>l.data).flat();if(!t)return null;const e={numerator:t[0],denominator:t[1],clocksPerTick:t[2],notesPerQuarter:t[3]},o=f.map(l=>l.event.filter(d=>d.type===9||d.type===8)).flat();return{name:n,signature:e,notes:z(o)}},q=async p=>new Promise((v,f)=>{const n=new FileReader;n.onload=t=>{if(!t.target){f("No target");return}const e=t.target.result,o=R.parse(e);v(K(o))},n.readAsDataURL(p)}),z=p=>{const v=[],f={};let n=0;for(const t of p)if(n+=t.deltaTime,t.type===9)f[t.data[0]]={start:n,velocity:t.data[1]};else if(t.type===8){const e=f[t.data[0]];if(!e)continue;const o=n-e.start;v.push({note:t.data[0],velocity:e.velocity,duration:o,start:e.start}),delete f[t.data[0]]}return v},Z={key:0,class:"keyboard"},_=A({__name:"MidiPreview",props:{track:{type:Object,required:!0},width:{type:Number,default:1e3},height:{type:Number,default:300}},setup(p){const v=p,f=w(()=>({width:v.width-20,height:v.height})),n=w(()=>v.track.notes),t=w(()=>{if(!n.value)return null;let s=Math.min(...n.value.map(h=>h.note)),i=Math.max(...n.value.map(h=>h.note));const u=Math.min(...n.value.map(h=>h.start)),c=Math.max(...n.value.map(h=>h.start+h.duration));return s=Math.floor(s/12)*12,i=Math.ceil(i/12)*12,{y:{min:s,max:i},x:{min:u,max:c}}}),e=w(()=>{if(!t.value)return null;const{x:s,y:i}=t.value,u=f.value.width/s.max,c=f.value.height/(i.max-i.min+1);return{x:u,y:c}}),o=()=>{if(!e.value||!t.value)return null;const{x:s,y:i}=t.value;return!s||!i?null:{height:`${e.value.y*(1+i.max-i.min)}px`,width:`${e.value.x*s.max}px`}},l=s=>{if(!e.value||!t.value)return null;const{x:i,y:u}=t.value;if(!i||!u)return null;const c=s.note-u.min,h=s.start;return{backgroundColor:"var(--accent)",position:"absolute",height:`${e.value.y}px`,width:`${s.duration*e.value.x}px`,bottom:`${c*e.value.y}px`,left:`${h*e.value.x}px`}},a=()=>{if(!e.value||!t.value)return null;const{x:s,y:i}=t.value;if(!s||!i)return null;const u=[];for(let c=i.min;c<=i.max;c++){const b=[1,3,6,8,10].includes(c%12)?"var(--color-background-soft)":"var(--color-background)",y=v.track.signature.clocksPerTick*v.track.signature.numerator,M=2**v.track.signature.denominator;let m="repeating-linear-gradient(to right,";for(let g=0;g<M;g++){const C=g%M===M-1?"black":"var(--color-background-soft)",N=g*y*e.value.x,$=(g+1)*y*e.value.x;m+=`${b} ${N+1}px,`,m+=`${b} ${$}px,`,m+=`${C} ${$}px,`,m+=`${C} ${$+1}px,`}m=m.slice(0,-1)+")",u.push({background:m,position:"absolute",height:`${e.value.y}px`,width:f.value.width+"px",bottom:`${(c-i.min)*e.value.y}px`,left:"0px"})}return u},d=()=>{if(!e.value||!t.value)return null;const{x:s,y:i}=t.value;if(!s||!i)return null;const u=[];for(let c=i.min;c<=i.max;c++){const h=[1,3,6,8,10].includes(c%12),b=c%12===0,F=h?"black":b?"lightgrey":"white",y=h?.7:1;u.push({backgroundColor:F,position:"absolute",height:`${e.value.y}px`,width:`${20*y}px`,bottom:`${(c-i.min)*e.value.y}px`,left:"0px"}),h&&u.push({backgroundColor:"white",position:"absolute",height:`${e.value.y}px`,width:`${20*(1-y)}px`,bottom:`${(c-i.min)*e.value.y}px`,left:`${y*100*e.value.x}px`})}return u},r=()=>{if(!e.value||!t.value)return null;const{x:s,y:i}=t.value;return!s||!i?null:{height:`${(1+i.max-i.min)*e.value.y}px`,width:"20px"}};return(s,i)=>p.track?(k(),x("div",Z,[L("div",{class:"keys",style:I(r())},[(k(!0),x(T,null,P(d(),u=>(k(),x("div",{style:I(u)},null,4))),256))],4),L("div",{class:"notes",style:I(o())},[(k(!0),x(T,null,P(a(),u=>(k(),x("div",{style:I(u)},null,4))),256)),(k(!0),x(T,null,P(n.value,u=>(k(),x("div",{class:"note",style:I(l(u))},null,4))),256))],4)])):D("",!0)}}),H=E(_,[["__scopeId","data-v-c531d95f"]]);export{H as M,q as m};

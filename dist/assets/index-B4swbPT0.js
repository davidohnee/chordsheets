import{q as A,i as p,s as O,v as P,d as E,u as I,o as w,c as S,a as s,b as v,F as T,r as U,t as $,g as B,_ as x,x as F,y as j,e as J,k as H,z as q,n as z}from"./main-c0_bQcCc.js";import{M as G}from"./MinWidth-C9O2BO_C.js";import{E as W}from"./Editor-C0B_bQTW.js";import{I as C}from"./IconButton-DuYX5QqJ.js";import{T as K}from"./TextInput-Ca73wkZq.js";import"./vuedraggable.umd-Bh1_f6WQ.js";/* empty css                                                               */import"./dom-to-image-CkUaIQJ9.js";/* empty css                                                                   */const N="chordsheets.history",Y=A("history",()=>{const o=p(JSON.parse(localStorage.getItem(N)||"[]")),i=P(()=>JSON.stringify(o.value));return O(o,()=>{localStorage.setItem(N,i.value)},{deep:!0}),{history:o,songEdited:a=>{const l=new Date().toISOString();o.value=[{songId:a,date:l},...o.value.filter(m=>m.songId!==a).slice(0,9)]}}}),Q="https://europe-west6-elated-effect-396715.cloudfunctions.net/spotify/token",M="https://api.spotify.com/v1";let _=null;const X=async()=>{if(_)return _;const n=await fetch(Q);if(!n.ok)throw new Error("Could not fetch token");return _=await n.text(),_},V=async()=>({Authorization:`Bearer ${await X()}`}),Z=async n=>(await fetch(`${M}/tracks/${n}`,{headers:await V()})).json(),ee=async n=>(await fetch(`${M}/audio-features/${n}`,{headers:await V()})).json(),te=n=>{const o={0:"C",1:"C♯",2:"D",3:"D♯",4:"E",5:"F",6:"F♯",7:"G",8:"G♯",9:"A",10:"A♯",11:"B"},i={0:"",1:"m"};return`${o[n.key]}${i[n.mode]}`},oe=async n=>{const[o,i]=await Promise.all([Z(n),ee(n)]);return{cover:o.album.images?.[0]?.url,name:o.name,artist:o.artists[0].name,album:o.album.name,href:o.external_urls.spotify,key:te(i),tempo:Math.round(i.tempo)}},se=n=>{const o=n.match(/track\/(\w+)/);if(!o)throw new Error("Invalid URL");return o[1]},ne={class:"row"},ae={key:0,class:"changes"},re={class:"content"},le={class:"material-symbols-rounded"},ie={class:"muted from"},ue=["onClick"],ce={class:"actions"},de=E({__name:"LinkSpotify",props:{song:{type:Object,required:!0}},setup(n,{expose:o}){I();const i=p(),u=p(),a=p({artist:{from:"",to:""},title:{from:"",to:""},bpm:{from:0,to:0},key:{from:"",to:""},cover:{from:"",to:""}}),l=n,m=()=>{i.value.showModal(),f()},f=async()=>{l.song.spotify&&(u.value=await oe(se(l.song.spotify)),u.value&&(a.value.artist={from:l.song.artist,to:u.value.artist},a.value.title={from:l.song.title,to:u.value.name},a.value.bpm={from:l.song.bpm,to:u.value.tempo},a.value.key={from:l.song.key,to:u.value.key},a.value.cover={from:l.song.cover,to:u.value.cover??""}))},d=e=>({bpm:"music_note",key:"piano",artist:"person",title:"title",cover:"image"})[e]??e,g=()=>{for(const e in a.value)l.song[e]=a.value[e].to},h=()=>{g(),i.value.close()};return o({show:m}),(e,c)=>(w(),S("dialog",{ref_key:"modal",ref:i},[c[4]||(c[4]=s("h1",null,"Link Spotify",-1)),s("div",null,[s("div",ne,[v(K,{label:"Spotify URI",modelValue:n.song.spotify,"onUpdate:modelValue":c[0]||(c[0]=k=>n.song.spotify=k),onChange:f},null,8,["modelValue"]),s("span",{onClick:f,class:"material-symbols-rounded"}," refresh ")]),u.value?(w(),S("div",ae,[c[3]||(c[3]=s("h3",null,"Changes",-1)),s("div",re,[(w(!0),S(T,null,U(a.value,(k,y)=>(w(),S(T,null,[s("span",le,$(d(y)),1),s("span",ie,$(k.from),1),c[2]||(c[2]=s("span",{class:"material-symbols-rounded"},"arrow_forward",-1)),v(K,{class:"to",modelValue:a.value[y].to,"onUpdate:modelValue":b=>a.value[y].to=b,disabled:!0},null,8,["modelValue","onUpdate:modelValue"]),s("span",{onClick:b=>delete a.value[y],class:"material-symbols-rounded"}," close ",8,ue)],64))),256))])])):B("",!0)]),s("div",ce,[v(C,{label:"Cancel",icon:"close",style:"red",onClick:c[1]||(c[1]=k=>i.value.close())}),v(C,{label:"Confirm",icon:"done",onClick:h,disabled:!u.value},null,8,["disabled"])])],512))}}),pe=x(de,[["__scopeId","data-v-d9d0d27b"]]),me={class:"actions"},fe=E({__name:"CleanupEmptySong",props:{song:{type:Object,required:!0}},emits:["close"],setup(n,{expose:o,emit:i}){const u=I(),a=p(),l=i,m=n,f=()=>{a.value.showModal()},d=()=>{a.value.close(),l("close")},g=()=>{u.removeSong(m.song),d()};return o({show:f}),(h,e)=>(w(),S("dialog",{ref_key:"modal",ref:a},[e[1]||(e[1]=s("h1",null,"Keep Song",-1)),e[2]||(e[2]=s("div",null,[s("p",null," You don't appear to have any content in this song. Do you want to keep it? ")],-1)),s("div",me,[v(C,{label:"Keep it",icon:"done",style:"green",onClick:e[0]||(e[0]=c=>d())}),v(C,{label:"Remove it",icon:"delete",style:"red",onClick:g})])],512))}}),ve=x(fe,[["__scopeId","data-v-c4ee76cf"]]),ye={class:"editor_container"},ge={class:"toolbar"},ke=E({__name:"index",setup(n){const o=I(),i=Y(),u=q(),a=z();let l=u.params.id;const m=p(),f=p(),d=p(!1),g=p();if(!l){const t=o.addEmptySong();a.push({path:`/editor/${t}`,replace:!0}),l=String(t)}const h=o.song(l);h||a.push("/");const e=p(h),c=()=>!(e.value.artist||e.value.title||e.value.instruments.length||e.value.sections.length||e.value.structure.length),k=()=>{if(c()){g.value?.show();return}a.back()},y=async()=>{await o.prepareRender();const t=await m.value.render();t&&(t.autoPrint(),window.open(t.output("bloburl"),"_blank"))},b=async()=>{await o.prepareRender();const t=await m.value.render();t&&t.save(`${e.value.title}.pdf`)},D=()=>{if(!e.value)return;const t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e.value)),r=document.createElement("a");r.setAttribute("href",t),r.setAttribute("download",`${e.value.title}.chordsheets.json`),document.body.appendChild(r),r.click(),r.remove()},L=t=>{t.ctrlKey&&t.key==="s"?(t.preventDefault(),D()):t.ctrlKey&&t.shiftKey&&t.key==="S"?(t.preventDefault(),b()):t.ctrlKey&&t.key==="p"?(t.preventDefault(),y()):t.ctrlKey&&t.shiftKey&&t.key==="P"&&(t.preventDefault(),d.value=!d.value)};return F(()=>{window.addEventListener("keydown",L),i.songEdited(e.value.id),console.log("showing link spotify",e.value.spotify,e.value.title),e.value.spotify&&!e.value.title&&setTimeout(()=>f.value?.show(),100)}),j(()=>{window.removeEventListener("keydown",L)}),(t,r)=>(w(),J(G,{minWidth:300},{default:H(()=>[v(pe,{ref_key:"linkSpotify",ref:f,song:e.value},null,8,["song"]),v(ve,{ref_key:"cleanupEmptySong",ref:g,song:e.value,onClose:r[0]||(r[0]=R=>t.$router.push("/browse"))},null,8,["song"]),s("div",ye,[s("a",{onClick:k,class:"back-button"},[...r[3]||(r[3]=[s("span",{class:"material-symbols-rounded"},"arrow_back",-1)])]),s("div",ge,[s("span",{class:"material-symbols-rounded",onClick:y,title:"Print (Ctrl+P)"}," print "),s("span",{class:"material-symbols-rounded",onClick:b,title:"Download as PDF (CTRL+SHIFT+S)"}," picture_as_pdf "),s("span",{class:"material-symbols-rounded",onClick:D,title:"Download as JSON (CTRL+S)"}," file_download "),r[4]||(r[4]=s("div",{class:"divider"},null,-1)),s("span",{class:"material-symbols-rounded",onClick:r[1]||(r[1]=R=>f.value?.show()),title:"Link Spotify"}," link "),r[5]||(r[5]=s("div",{class:"divider"},null,-1)),s("span",{class:"material-symbols-rounded",onClick:r[2]||(r[2]=R=>d.value=!d.value),title:"Preview (CTRL+SHIFT+P)"},$(d.value?"preview_off":"preview"),1)]),v(W,{ref_key:"editor",ref:m,song:e.value,printing:d.value},null,8,["song","printing"])])]),_:1}))}}),xe=x(ke,[["__scopeId","data-v-0cac8911"]]);export{xe as default};
